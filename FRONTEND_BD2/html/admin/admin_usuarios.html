<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usuários - Admin</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-admin">
        
        <aside class="admin-sidebar">
            <h2>Gestão de Usuários</h2>
            <nav>
                <ul>
                    <li><a href="admin_dashboard.html">Visão Geral</a></li>
                    <li><a href="admin_animais.html">Gerenciar Animais</a></li>
                    <li class="active"><a href="admin_usuarios.html">Gerenciar Usuários</a></li>
                    <li><a href="admin_eventos_portal.html">Eventos/Portal</a></li>
                    <li><a href="#" onclick="logout()">Sair</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-content">
            <h1 class="titulo-login">Gerenciar Usuários</h1>

            <section class="admin-form-container mb-5">
                <h2>Buscar Usuário por E-mail</h2>
                <form id="form-buscar-usuario" class="d-flex justify-content-center">
                    <input type="email" id="email-busca" class="form-control me-2" placeholder="Digite o e-mail" required style="max-width: 300px;">
                    <button type="submit" class="btn btn-secondary ms-2" >Buscar</button>
                    <button type="button" class="btn btn-secondary ms-2" onclick="listarTodosUsuarios()">Listar Todos</button>
                </form>
                <div id="busca-status" class="mt-3" style="color: blue;"></div>
            </section>

            <section class="admin-table-container">
                <h2>Resultados da Busca</h2>
                <table id="tabela-usuarios" class="tabela-eventos mx-auto">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>CPF</th>
                            <th>Tipo</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <section class="admin-form-container mb-5">
                <h2><span id="form-titulo">Criar Novo Usuário</span></h2>
                <form id="form-usuario" class="login-form p-4 mx-auto">
                    <input type="hidden" id="id-usuario" name="idUsuario">

                    <div class="campo">
                        <label for="nome">Nome:</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>

                    <div class="campo">
                        <label for="email">E-mail:</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="campo">
                        <label for="cpf">CPF:</label>
                        <input type="text" id="cpf" name="cpf" maxlength="11" required>
                    </div>

                    <div class="campo">
                        <label for="tipoUsuario">Tipo:</label>
                        <select id="tipoUsuario" name="tipoUsuario" class="form-control" required>
                            <option value="comum">Comum</option>
                            <option value="funcionario">Funcionário</option>
                            <option value="administrador">Administrador</option>
                        </select>
                    </div>
                    
                    <div class="campo">
                        <label for="senha">Senha:</label>
                        <input type="password" id="senha" name="senha" required>
                    </div>

                    <div class="acoes">
                        <button type="submit" class="btn">Salvar</button>
                        <button type="reset" class="btn" onclick="resetFormulario()">Cancelar/Novo</button>
                    </div>
                </form>
            </section>

            

        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/adocao'; // Base da API
        const API_USUARIOS = `${API_BASE_URL}/usuarios`;
        
        // --- FUNÇÕES DE UTILIDADE ---
        function logout() {
            localStorage.removeItem('usuarioLogado');
            window.location.href = '../login.html';
        }

        function checkAdmin() {
            // Garante que o usuário está logado e é administrador (Regra de Ouro)
            const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
            if (!usuarioLogado || usuarioLogado.tipoUsuario !== 'administrador') {
                alert('Acesso negado. Redirecionando para login.');
                window.location.href = 'login.html';
            }
        }

        function resetFormulario() {
            document.getElementById('form-usuario').reset();
            document.getElementById('id-usuario').value = '';
            document.getElementById('form-titulo').textContent = 'Criar Novo Usuário';
            document.getElementById('senha').required = true; // Senha é obrigatória na criação
        }

        function exibirResultado(data) {
            const tbody = document.querySelector('#tabela-usuarios tbody');
            tbody.innerHTML = '';
            
            // Se a busca retornar um único objeto (Busca por Email), coloque-o em um array
            const resultados = Array.isArray(data) ? data : [data];
            
            if (resultados.length === 0 || (resultados.length === 1 && resultados[0].error)) {
                 document.getElementById('busca-status').textContent = resultados.length === 1 && resultados[0].error ? resultados[0].error : 'Nenhum usuário encontrado.';
                return;
            }
             document.getElementById('busca-status').textContent = `${resultados.length} usuário(s) encontrado(s).`;


            resultados.forEach(user => {
                const row = tbody.insertRow();
                row.insertCell().textContent = user.idUsuario;
                row.insertCell().textContent = user.nome;
                row.insertCell().textContent = user.email;
                row.insertCell().textContent = user.cpf;
                row.insertCell().textContent = user.tipoUsuario;
                
                const acoesCell = row.insertCell();
                acoesCell.innerHTML = `
                    <button class="btn btn-sm btn-primary me-2" onclick="prepararEdicao(${user.idUsuario})">Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="deletarUsuario(${user.idUsuario})">Deletar</button>
                `;
            });
        }
        
        // --- FUNÇÕES DE DADOS (CRUD) ---

        async function buscarUsuario(url) {
            try {
                const response = await fetch(url);
                if (response.status === 404) {
                    exibirResultado([]); // Nenhum resultado encontrado
                } else if (!response.ok) {
                    throw new Error(`Erro ${response.status}: Falha na requisição.`);
                }
                const data = await response.json();
                exibirResultado(data);
            } catch (error) {
                document.getElementById('busca-status').textContent = `Erro: ${error.message}`;
            }
        }
        
        async function listarTodosUsuarios() {
            document.getElementById('busca-status').textContent = 'Listando todos...';
            buscarUsuario(API_USUARIOS);
        }

        async function deletarUsuario(id) {
            if (!confirm(`Tem certeza que deseja deletar o usuário ID ${id}?`)) return;

            try {
                const response = await fetch(`${API_USUARIOS}/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert(`Usuário ID ${id} deletado com sucesso!`);
                    listarTodosUsuarios(); // Recarrega a lista
                } else {
                    const erro = await response.json();
                    alert(`Erro ao deletar: ${erro.error || 'Verifique se há animais ou eventos vinculados.'}`);
                }
            } catch (error) {
                alert(`Erro de conexão ao deletar: ${error.message}`);
            }
        }

        async function prepararEdicao(id) {
            try {
                const response = await fetch(`${API_USUARIOS}/${id}`);
                const user = await response.json();
                
                if (user.error) throw new Error(user.error);

                // Preenche o formulário para edição
                document.getElementById('id-usuario').value = user.idUsuario;
                document.getElementById('nome').value = user.nome;
                document.getElementById('email').value = user.email;
                document.getElementById('cpf').value = user.cpf;
                document.getElementById('tipoUsuario').value = user.tipoUsuario;
                document.getElementById('senha').value = ''; 
                document.getElementById('senha').required = false; // Senha opcional na edição
                document.getElementById('form-titulo').textContent = `Editar Usuário ID ${user.idUsuario}`;
                
                // Rola para o formulário
                document.getElementById('form-usuario').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                alert(`Erro ao buscar dados para edição: ${error.message}`);
            }
        }
        
        // --- EVENT HANDLERS ---
        
        document.getElementById('form-usuario').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const id = document.getElementById('id-usuario').value;
            const isEditing = id !== '';
            
            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `${API_USUARIOS}/${id}` : API_USUARIOS;
            
            // Coleta os dados do formulário
            const data = {
                idUsuario: id ? parseInt(id) : undefined,
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                cpf: document.getElementById('cpf').value,
                tipoUsuario: document.getElementById('tipoUsuario').value,
                senha: document.getElementById('senha').value 
            };
            
            // Remove a senha do PUT se estiver vazia (para não atualizar a senha no DB)
            if (isEditing && data.senha === '') {
                delete data.senha;
            } else if (!isEditing && data.senha === '') {
                alert('A senha é obrigatória para novos usuários.');
                return;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert(`Usuário ${isEditing ? 'atualizado' : 'criado'} com sucesso!`);
                    resetFormulario();
                    listarTodosUsuarios();
                } else {
                    const erro = await response.json();
                    alert(`Falha: ${erro.error || 'Erro desconhecido.'}`);
                }
            } catch (error) {
                alert(`Erro de conexão ao ${method}: ${error.message}`);
            }
        });

        document.getElementById('form-buscar-usuario').addEventListener('submit', function(event) {
            event.preventDefault();
            const email = document.getElementById('email-busca').value;
            // Busca específica por parâmetro de query
            buscarUsuario(`${API_USUARIOS}?email=${email}`);
        });

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAdmin();
            listarTodosUsuarios();
        });
    </script>
</body>
</html>