<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Funcionário</title>
    <link rel="stylesheet" href="../../css/style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Reutilizando estilos de layout do Admin */
        .container-admin { display: flex; min-height: 100vh; background-color: #f7eee3; }
        .admin-sidebar { width: 250px; background-color: #e75d8b; color: white; padding: 20px 0; position: fixed; top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 1000; }
        .admin-content { flex-grow: 1; padding: 30px; text-align: left; margin-left: 250px; min-height: 100vh; background-color: #f7eee3; }
        .admin-sidebar h2 { color: white; font-family: 'Sour Gummy'; text-align: center; margin-bottom: 30px; padding: 0 10px; }
        .admin-sidebar ul { list-style: none; padding: 0; }
        .admin-sidebar ul li a { display: block; padding: 15px 20px; text-decoration: none; color: white; font-weight: bold; font-family: 'Nunito', Arial, sans-serif; transition: background-color 0.3s ease; }
        .admin-sidebar ul li a:hover, .admin-sidebar ul li.active a { background-color: #e43a72; color: #fff; }
    </style>
</head>
<body>
    <div class="container-admin">
        
        <aside class="admin-sidebar">
            <h2>Área do Funcionário</h2>
            <nav>
                <ul>
                    <li><a href="funcionario_animais.html">Gerenciar Animais</a></li>
                    <li><a href="funcionario_adocoes.html">Adoções Pendentes</a></li> 
                    <li class="active"><a href="funcionario_perfil.html">Meus Dados</a></li>
                    <li><a href="#" onclick="logout()">Sair</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-content">
            <h1 class="titulo-login">Meu Perfil</h1>

            <section class="admin-form-container p-5 mx-auto" style="max-width: 700px;">
                <form id="formPerfil">
                    <input type="hidden" id="idUsuario">
                    <input type="hidden" id="tipoUsuario">

                    <div id="msg-status" class="text-center mb-3 fw-bold"></div>

                    <div class="mb-3">
                        <label for="nome" class="form-label fw-bold">Nome Completo:</label>
                        <input type="text" id="nome" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="cpf" class="form-label fw-bold">CPF:</label>
                        <input type="text" id="cpf" class="form-control" required readonly style="background-color: #e9ecef;">
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label fw-bold">E-mail:</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>

                    <hr class="my-4">
                    <p class="text-muted text-center small">Preencha a senha apenas se desejar alterá-la</p>

                    <div class="mb-3">
                        <label for="senha" class="form-label fw-bold">Nova Senha:</label>
                        <input type="password" id="senha" class="form-control" maxlength="8" placeholder="Deixe em branco para manter a atual">
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmaSenha" class="form-label fw-bold">Confirmar Senha:</label>
                        <input type="password" id="confirmaSenha" class="form-control" maxlength="8" placeholder="Repita a nova senha">
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn" style="background-color: #e75d8b; color: white; font-weight: bold;">Salvar Alterações</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <script>
        const API_USUARIOS = 'http://localhost:8080/adocao/usuarios';
        let usuarioLogado = null;

        function logout() {
            localStorage.removeItem('usuarioLogado');
            window.location.href = '../login.html';
        }

        function checkFuncionario() {
            const userJson = localStorage.getItem('usuarioLogado');
            if (!userJson) {
                window.location.href = '../login.html';
                return;
            }
            usuarioLogado = JSON.parse(userJson);
            
            // Permite Apenas Funcionário ou Admin
            if (usuarioLogado.tipoUsuario !== 'funcionario' && usuarioLogado.tipoUsuario !== 'administrador') {
                alert('Acesso restrito.');
                window.location.href = '../login.html';
            }
        }

        // --- CARREGAR DADOS ---
        async function carregarMeusDados() {
            try {
                const response = await fetch(`${API_USUARIOS}/${usuarioLogado.idUsuario}`);
                if (!response.ok) throw new Error('Erro ao buscar dados.');
                
                const usuario = await response.json();
                
                document.getElementById('idUsuario').value = usuario.idUsuario;
                document.getElementById('tipoUsuario').value = usuario.tipoUsuario;
                document.getElementById('nome').value = usuario.nome;
                document.getElementById('email').value = usuario.email;
                document.getElementById('cpf').value = usuario.cpf;

            } catch (error) {
                const msgDiv = document.getElementById('msg-status');
                msgDiv.textContent = 'Erro ao carregar dados. Tente recarregar.';
                msgDiv.style.color = 'red';
            }
        }

        // --- ATUALIZAR DADOS (PUT) ---
        document.getElementById('formPerfil').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const msgDiv = document.getElementById('msg-status');
            const senha = document.getElementById('senha').value;
            const confirma = document.getElementById('confirmaSenha').value;

            msgDiv.textContent = 'Salvando...';
            msgDiv.style.color = 'blue';

            if (senha && senha !== confirma) {
                msgDiv.textContent = 'As senhas não coincidem.';
                msgDiv.style.color = 'red';
                return;
            }

            const dadosAtualizados = {
                idUsuario: parseInt(document.getElementById('idUsuario').value),
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                cpf: document.getElementById('cpf').value,
                tipoUsuario: document.getElementById('tipoUsuario').value,
                senha: senha 
            };

            try {
                const response = await fetch(`${API_USUARIOS}/${dadosAtualizados.idUsuario}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosAtualizados)
                });

                if (response.ok) {
                    msgDiv.textContent = 'Perfil atualizado com sucesso!';
                    msgDiv.style.color = 'green';

                    // Atualiza localStorage
                    dadosAtualizados.senha = null; 
                    localStorage.setItem('usuarioLogado', JSON.stringify(dadosAtualizados));

                    setTimeout(() => { msgDiv.textContent = ''; }, 3000);
                } else {
                    const erro = await response.json();
                    msgDiv.textContent = `Erro: ${erro.error || 'Falha ao atualizar.'}`;
                    msgDiv.style.color = 'red';
                }
            } catch (error) {
                msgDiv.textContent = 'Erro de conexão com o servidor.';
                msgDiv.style.color = 'red';
            }
        });

        // INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', () => {
            checkFuncionario();
            carregarMeusDados();
        });
    </script>
</body>
</html>