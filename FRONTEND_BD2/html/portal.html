<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Portal da Transparência - Animais do Bem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-md navbar-light">
            <div class="container">
                <img src="../resources/img/logo.png" alt="Logo" width="120" height="50" class="d-inline-block align-text-top">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuNav" aria-controls="menuNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="menuNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="quemsomos.html">Quem Somos</a></li>
                        <li class="nav-item"><a class="nav-link" href="adote.html">Adote</a></li>
                        <li class="nav-item"><a class="nav-link" href="doar.html">Doar</a></li>
                        <li class="nav-item"><a class="nav-link" href="parceiros.html">Parceiros</a></li>
                        <li class="nav-item"><a class="nav-link" href="portal.html">Portal da Transparência</a></li>
                    </ul>

                    <div id="auth-actions">
                        </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="container-principal">
            <h1>Portal de Transparência</h1>
            <p>Para onde minhas doações estão indo?</p>
                <p class="text-justify">
                    Neste portal, são disponibilizados os valores referentes às despesas do ano vigente, 
                    apresentados de forma detalhada mês a mês. As informações incluem gastos individualizados 
                    e demais itens necessários para o funcionamento das atividades.O objetivo é oferecer 
                    uma visualização clara da aplicação dos recursos, permitindo consulta pública e garantindo 
                    acesso direto aos dados financeiros que compõem o balanço anual. A disponibilização dessas 
                    informações reforça a transparência institucional e assegura que a utilização dos recursos
                    seja acompanhada de maneira responsável e verificável.
                </p>
            <div id="loading-status" class="text-center text-secondary mb-3">Carregando dados financeiros...</div>

            <table class="tabela-eventos">
                <thead class="table-light">
                    <tr>
                        <th>Ano</th>
                        <th>Dia/Mês</th>
                        <th>Gasto com Ração (R$)</th>
                        <th>Gasto com Água (R$)</th>
                        <th>Gasto com Vacina (R$)</th>
                    </tr>
                </thead>
                <tbody id="tabelaDados"></tbody> 
            </table>
        </div>
    </main>

    <footer class="text-center mt-5 mb-3">
        <p>&copy; 2025 Animais do Bem. Todos os direitos reservados.</p>
        <p>Contato: <a href="mailto:contato@animaisdobem.org">animaisdobem@ifsp.edu.br</a></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> 
    
    <script>
        const API_PORTAL = 'http://localhost:8080/adocao/portal';

        // Mapeamento de meses (necessário para exibição)
        const meses = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];

        /**
         * FUNÇÕES DE AUTENTICAÇÃO
         */
        function logout() {
            localStorage.removeItem('usuarioLogado');
            window.location.href = 'home.html'; 
        }

        function renderLoggedUser(usuario) {
            const authActionsDiv = document.getElementById('auth-actions');
            authActionsDiv.innerHTML = `
                <div class="dropdown">
                    <button class="btn btn-login dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle me-1"></i> ${usuario.nome}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton1">
                        <li><a class="dropdown-item" href="perfil.html">
                            <i class="bi bi-gear-fill me-2"></i> Atualizar Perfil
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i> Sair
                        </a></li>
                    </ul>
                </div>
            `;
            window.logout = logout; 
        }

        function renderLoginButton() {
            const authActionsDiv = document.getElementById('auth-actions');
            authActionsDiv.innerHTML = `
                <div>
                    <a class="btn btn-login me-2" href="login.html">Login</a>
                </div>
            `;
        }

        function checkLoginStatus() {
            const usuarioJSON = localStorage.getItem('usuarioLogado');
            
            if (usuarioJSON) {
                try {
                    const usuario = JSON.parse(usuarioJSON);
                    renderLoggedUser(usuario);
                } catch (e) {
                    localStorage.removeItem('usuarioLogado'); 
                    renderLoginButton();
                }
            } else {
                renderLoginButton();
            }
        }
        
        /**
         * FUNÇÃO DE CARREGAMENTO DE DADOS DO PORTAL
         */
        async function carregarDadosPortal() {
            const tbody = document.getElementById('tabelaDados');
            const statusDiv = document.getElementById('loading-status');
            
            tbody.innerHTML = '';
            statusDiv.textContent = 'Carregando dados financeiros...';

            try {
                const response = await fetch(API_PORTAL);
                
                if (!response.ok) {
                    statusDiv.textContent = `Erro ${response.status}: Falha ao buscar dados do servidor.`;
                    return;
                }
                
                const dadosBrutos = await response.json();
                
                if (dadosBrutos.length === 0) {
                    statusDiv.textContent = 'Nenhum registro de transparência encontrado.';
                    return;
                }
                
                // Ordena por data (mais recente primeiro)
                dadosBrutos.sort((a, b) => new Date(b.dataRegistro) - new Date(a.dataRegistro));

                // Renderizar a tabela com DADOS INDIVIDUAIS
                dadosBrutos.forEach(item => {
                    const row = tbody.insertRow();
                    
                    const [ano, mesNum, dia] = item.dataRegistro.split('-');
                    
                    row.insertCell().textContent = ano;
                    row.insertCell().textContent = `${dia}/${mesNum}`; // Exibe a data completa (Dia/Mês)
                    
                    // Valores formatados para moeda (R$)
                    row.insertCell().textContent = `R$ ${item.valorRacao.toFixed(2)}`;
                    row.insertCell().textContent = `R$ ${item.valorAgua.toFixed(2)}`;
                    row.insertCell().textContent = `R$ ${item.valorVacina.toFixed(2)}`;
                });

                statusDiv.style.display = 'none'; // Esconde o status se for sucesso

            } catch (error) {
                console.error('Erro de rede/processamento:', error);
                statusDiv.textContent = `Erro crítico ao carregar dados: ${error.message}`;
                tbody.innerHTML = '<tr><td colspan="5" class="text-danger">Não foi possível carregar os dados financeiros.</td></tr>';
            }
        }

        // Inicia a verificação de login e o carregamento de dados no carregamento da página
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            carregarDadosPortal();
        });
    </script>
</body>
</html>