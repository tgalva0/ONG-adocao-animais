<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Home - Animais do Bem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-md navbar-light">
            <div class="container">
                <img src="/resources/img/logo.png" alt="Logo" width="120" height="50" class="d-inline-block align-text-top">

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuNav" aria-controls="menuNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="menuNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="quemsomos.html">Quem Somos</a></li>
                        <li class="nav-item"><a class="nav-link" href="adote.html">Adote</a></li>
                        <li class="nav-item"><a class="nav-link" href="doar.html">Doar</a></li>
                        <li class="nav-item"><a class="nav-link" href="parceiros.html">Parceiros</a></li>
                        <li class="nav-item"><a class="nav-link" href="portal.html">Portal da Transparência</a></li>
                    </ul>

                    <div id="auth-actions">
                        </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="container-principal">
            <section id="carrossel-home">
                <div id="carouselExampleSlidesOnly" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item">
                            <img src="../resources/img/carrosel/carroselpet.jpg" class="d-block w-100" alt="Pets">
                        </div>
                        <div class="carousel-item active">
                            <img src="../resources/img/carrosel/carroselbem.jpg" class="d-block w-100" alt="Seja Bem Vindo">
                        </div>
                    </div>
                </div>
            </section>

            <section id="cards-home" class="container my-5">
                <div class="row g-4 text-center">
                    <div class="col-md-4">
                        <div class="card card-home h-100">
                            <img src="../resources/img/doacao.jpg" class="card-img-top" alt="Doação">
                            <div class="card-body">
                                <h5 class="card-title">Faça uma Doação</h5>
                                <p class="card-text">Contribua para cuidar e proteger nossos amiguinhos!</p>
                                <a href="doar.html" class="btn btn-home">Saiba Mais</a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-home h-100">
                            <img src="https://images.pexels.com/photos/16395147/pexels-photo-16395147.jpeg" class="card-img-top" alt="Adote">
                            <div class="card-body">
                                <h5 class="card-title">Quero Adotar!</h5>
                                <p class="card-text">Encontre seu novo amigo e transforme vidas!</p>
                                <a href="adote.html" class="btn btn-home">Saiba Mais</a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-home h-100">
                            <img src="../resources/img/patinhas.png" class="card-img-top" alt="Parceiros">
                            <div class="card-body">
                                <h5 class="card-title">Conheça nossos Parceiros</h5>
                                <p class="card-text">Descubra quem nos ajuda a cuidar dos pets!</p>
                                <a href="parceiros.html" class="btn btn-home">Saiba Mais</a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <h2>Próximos Eventos</h2>
            <div id="eventos-status" class="text-center text-secondary mb-3">Carregando eventos...</div>
            
            <table class="tabela-eventos">
                <thead>
                    <tr>
                        <th>Nome do Evento</th>
                        <th>Data</th>
                        <th>Descrição</th>
                    </tr>
                </thead>
                <tbody id="tabela-eventos-home">
                    </tbody>
            </table>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Animais do Bem. Todos os direitos reservados.</p>
        <p>Contato: <a href="mailto:contato@animaisdobem.org">animaisdobem@ifsp.edu.br</a></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_EVENTOS = 'http://localhost:8080/adocao/eventos'; 

        /**
         * Função para realizar o logout: remove o usuário do localStorage e recarrega a página.
         */
        function logout() {
            localStorage.removeItem('usuarioLogado');
            window.location.href = 'home.html'; 
        }

        /**
         * Renderiza o menu de usuário logado (dropdown).
         */
        function renderLoggedUser(usuario) {
            const authActionsDiv = document.getElementById('auth-actions');
            
            authActionsDiv.innerHTML = `
                <div class="dropdown">
                    <button class="btn btn-login dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle me-1"></i> ${usuario.nome}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton1">
                        <li><a class="dropdown-item" href="perfil.html">
                            <i class="bi bi-gear-fill me-2"></i> Atualizar Perfil
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i> Sair
                        </a></li>
                    </ul>
                </div>
            `;
            window.logout = logout; 
        }

        /**
         * Renderiza o botão de login padrão.
         */
        function renderLoginButton() {
            const authActionsDiv = document.getElementById('auth-actions');
            authActionsDiv.innerHTML = `
                <div>
                    <a class="btn btn-login me-2" href="login.html">Login</a>
                </div>
            `;
        }

        /**
         * Checa o status do login no localStorage e renderiza a navbar apropriadamente.
         */
        function checkLoginStatus() {
            const usuarioJSON = localStorage.getItem('usuarioLogado');
            
            if (usuarioJSON) {
                try {
                    const usuario = JSON.parse(usuarioJSON);
                    renderLoggedUser(usuario);
                } catch (e) {
                    localStorage.removeItem('usuarioLogado'); 
                    renderLoginButton();
                }
            } else {
                renderLoginButton();
            }
        }
        
        /**
         * CARREGA E EXIBE EVENTOS DO BACKEND
         */
        async function carregarEventos() {
            const tbody = document.getElementById('tabela-eventos-home');
            const statusDiv = document.getElementById('eventos-status');
            
            tbody.innerHTML = '';
            statusDiv.textContent = 'Buscando eventos no servidor...';

            try {
                const response = await fetch(API_EVENTOS);
                
                if (!response.ok) {
                    statusDiv.textContent = `Erro ${response.status}: Falha ao buscar eventos.`;
                    return;
                }
                
                const eventos = await response.json();
                
                if (eventos.length === 0) {
                    statusDiv.textContent = 'Nenhum evento futuro agendado.';
                    return;
                }
                
                // Ordena por data (opcional, mas bom para eventos)
                eventos.sort((a, b) => new Date(a.dataEvento) - new Date(b.dataEvento));

                // 2. Renderizar a tabela
                eventos.forEach(evento => {
                    const row = tbody.insertRow();
                    // Converte a data ISO (AAAA-MM-DD) para DD/MM/AAAA
                    const dataFormatada = evento.dataEvento ? evento.dataEvento.split('-').reverse().join('/') : 'N/D';

                    row.insertCell().textContent = evento.nomeEvento;
                    row.insertCell().textContent = dataFormatada;
                    // Insere a descrição completa na coluna final
                    row.insertCell().textContent = evento.descricao; 
                });

                statusDiv.style.display = 'none'; 

            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
                statusDiv.textContent = `Erro crítico: ${error.message}. Não foi possível conectar ao servidor.`;
                tbody.innerHTML = '<tr><td colspan="3" class="text-danger">Não foi possível carregar a lista de eventos.</td></tr>';
            }
        }

        // 3. INICIA APLICAÇÃO (Chamada no final do carregamento)
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus(); // Verifica o login
            carregarEventos();  // Carrega a tabela de eventos dinamicamente
        });
    </script>
</body>
</html>