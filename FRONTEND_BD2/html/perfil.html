<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meu Perfil - Animais do Bem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-md navbar-light">
            <div class="container">
                <img src="../resources/img/logo.png" alt="Logo" width="120" height="50" class="d-inline-block align-text-top">

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuNav" aria-controls="menuNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="menuNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="quemsomos.html">Quem Somos</a></li>
                        <li class="nav-item"><a class="nav-link" href="adote.html">Adote</a></li>
                        <li class="nav-item"><a class="nav-link" href="doar.html">Doar</a></li>
                        <li class="nav-item"><a class="nav-link" href="parceiros.html">Parceiros</a></li>
                        <li class="nav-item"><a class="nav-link" href="portal.html">Portal da Transparência</a></li>
                        <li class="nav-item"><a class="nav-link" href="contato.html">Contato</a></li>
                    </ul>
                    
                    <div id="auth-actions"></div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="container-principal">
            <h1>Meus Dados</h1>
            
            <form id="formPerfil" class="cadastro-form">
                <input type="hidden" id="idUsuario">
                <input type="hidden" id="tipoUsuario">

                <fieldset>
                    <h2>Atualizar Perfil</h2>
                    
                    <div id="msg-status" class="text-center mb-3" style="font-weight: bold;"></div>

                    <div class="campo">
                        <label for="nome">Nome Completo</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>

                    <div class="campo">
                        <label for="cpf">CPF</label>
                        <input type="text" id="cpf" name="cpf" required readonly style="background-color: #e9ecef; cursor: not-allowed;">
                    </div>

                    <div class="campo">
                        <label for="email">E-mail</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <hr>
                    <p class="text-center text-muted small">Preencha a senha apenas se desejar alterá-la</p>

                    <div class="campo">
                        <label for="senha">Nova Senha</label>
                        <input type="password" id="senha" name="senha" maxlength="8" placeholder="Deixe em branco para manter">
                    </div>

                    <div class="campo">
                        <label for="confirmaSenha">Confirme a Senha</label>
                        <input type="password" id="confirmaSenha" maxlength="8" placeholder="Repita a nova senha">
                    </div>

                    <div class="acoes">
                        <button type="submit" class="btn">Salvar Alterações</button>
                    </div>

                    <div class="text-center mt-3">
                        <a href="home.html" style="color: #e75d8b; text-decoration: underline;">Cancelar e Voltar</a>
                    </div>
                </fieldset>
            </form>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Animais do Bem. Todos os direitos reservados.</p>
        <p>Contato: <a href="mailto:contato@animaisdobem.org">animaisdobem@ifsp.edu.br</a></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_USUARIOS = 'http://localhost:8080/adocao/usuarios';
        let usuarioLogado = null;

        // --- 1. VERIFICAÇÃO DE SEGURANÇA E LOAD ---
        function initPerfil() {
            const userJson = localStorage.getItem('usuarioLogado');
            if (!userJson) {
                alert('Você precisa estar logado para acessar o perfil.');
                window.location.href = 'login.html';
                return;
            }
            usuarioLogado = JSON.parse(userJson);
            renderNavbar(usuarioLogado); // Mostra o menu no topo
            carregarDadosDoBackend(usuarioLogado.idUsuario);
        }

        // --- 2. CARREGAR DADOS DO SERVIDOR ---
        async function carregarDadosDoBackend(id) {
            try {
                const response = await fetch(`${API_USUARIOS}/${id}`);
                if (!response.ok) throw new Error('Erro ao buscar dados do usuário.');
                
                const usuario = await response.json();
                
                // Preenche o formulário
                document.getElementById('idUsuario').value = usuario.idUsuario;
                document.getElementById('tipoUsuario').value = usuario.tipoUsuario;
                document.getElementById('nome').value = usuario.nome;
                document.getElementById('email').value = usuario.email;
                document.getElementById('cpf').value = usuario.cpf;

            } catch (error) {
                console.error(error);
                const msgDiv = document.getElementById('msg-status');
                msgDiv.textContent = 'Erro ao carregar seus dados. Tente recarregar a página.';
                msgDiv.style.color = 'red';
            }
        }

        // --- 3. ATUALIZAR DADOS (PUT) ---
        document.getElementById('formPerfil').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const msgDiv = document.getElementById('msg-status');
            const senha = document.getElementById('senha').value;
            const confirma = document.getElementById('confirmaSenha').value;

            msgDiv.textContent = 'Salvando...';
            msgDiv.style.color = 'blue';

            // Validação de Senha (apenas se o usuário digitou algo)
            if (senha && senha !== confirma) {
                msgDiv.textContent = 'As senhas não coincidem.';
                msgDiv.style.color = 'red';
                return;
            }

            const dadosAtualizados = {
                idUsuario: parseInt(document.getElementById('idUsuario').value),
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                cpf: document.getElementById('cpf').value, // CPF é enviado para validar integridade, mas não muda
                tipoUsuario: document.getElementById('tipoUsuario').value,
                senha: senha // Pode ir vazia, o backend decide se atualiza ou não
            };

            try {
                const response = await fetch(`${API_USUARIOS}/${dadosAtualizados.idUsuario}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosAtualizados)
                });

                if (response.ok) {
                    msgDiv.textContent = 'Dados atualizados com sucesso!';
                    msgDiv.style.color = 'green';

                    // Atualiza o localStorage (exceto senha)
                    dadosAtualizados.senha = null; 
                    localStorage.setItem('usuarioLogado', JSON.stringify(dadosAtualizados));

                    // Atualiza a navbar
                    renderNavbar(dadosAtualizados);

                    setTimeout(() => { msgDiv.textContent = ''; }, 3000);
                } else {
                    const erro = await response.json();
                    msgDiv.textContent = `Erro: ${erro.error || 'Falha ao atualizar.'}`;
                    msgDiv.style.color = 'red';
                }
            } catch (error) {
                msgDiv.textContent = 'Erro de conexão com o servidor.';
                msgDiv.style.color = 'red';
            }
        });

        // --- 4. FUNÇÕES DA NAVBAR ---
        function logout() {
            localStorage.removeItem('usuarioLogado');
            window.location.href = 'home.html'; 
        }

        function renderNavbar(usuario) {
            const authActionsDiv = document.getElementById('auth-actions');
            authActionsDiv.innerHTML = `
                <div class="dropdown">
                    <button class="btn btn-login dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i> ${usuario.nome}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item active" href="perfil.html"><i class="bi bi-gear-fill me-2"></i> Atualizar Perfil</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i> Sair</a></li>
                    </ul>
                </div>
            `;
            window.logout = logout;
        }

        // INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', initPerfil);
    </script>
</body>
</html>